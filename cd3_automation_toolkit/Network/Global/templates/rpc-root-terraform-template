# Copyright (c) 2024, Oracle and/or its affiliates. All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.
#
####################################################
# Root Module Block - Network
####################################################

module "rpcs" {
  source   = "../modules/rpc"
  for_each = var.drg_other_attachments

  requester_compartment_id = each.value.requester_compartment_id != null ? (length(regexall("ocid1.compartment.oc*", each.value.requester_compartment_id)) > 0 ? each.value.requester_compartment_id : var.compartment_ocids[each.value.requester_compartment_id]) : null
  accepter_compartment_id  = each.value.accepter_compartment_id != null ? (length(regexall("ocid1.compartment.oc*", each.value.accepter_compartment_id)) > 0 ? each.value.accepter_compartment_id : var.compartment_ocids[each.value.accepter_compartment_id]) : null
  display_name             = each.value.display_name

  #Requester
  requester_region             = each.value.requester_region
  requester_drg_name           = each.value.requester_drg_name
  requester_drg_rt_name        = each.value.requester_drg_rt_name != "null" ? each.value.requester_drg_rt_name : "Autogenerated Drg Route Table for RPC, VC, and IPSec attachments"

  #Accepter
  accepter_region             = each.value.accepter_region
  accepter_drg_name           = each.value.accepter_drg_name
  accepter_drg_rt_name        = each.value.accepter_drg_rt_name != "null" ? each.value.accepter_drg_rt_name : "Autogenerated Drg Route Table for RPC, VC, and IPSec attachments"
  accepter_rpc_display_name   = each.value.accepter_rpc_display_name
  defined_tags                          = each.value.defined_tags
  freeform_tags                         = each.value.freeform_tags

  providers = {
        {% for region in subscribed_regions %}
          {% set region_keys = region.split('-') %}
             oci.{{region_keys[1]}} = oci.{{region_keys[1]}}
        {% endfor %}
        }
}

###########################
# Providers Block - Network
###########################


{% for region in subscribed_regions %}
   {% set region_keys = region.split('-') %}

    provider "oci" {
    tenancy_ocid        = var.tenancy_ocid
    user_ocid           = var.user_ocid
    fingerprint         = var.fingerprint
    private_key_path    = var.private_key_path
    region              = "{{ region }}"
    ignore_defined_tags = ["Oracle-Tags.CreatedBy", "Oracle-Tags.CreatedOn"]
    alias               = "{{ region_keys[1] }}"
}
{% endfor %}
