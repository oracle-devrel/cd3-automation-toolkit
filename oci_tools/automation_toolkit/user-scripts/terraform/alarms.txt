// Copyright (c) 2021, 2022, Oracle and/or its affiliates.

############################
# Module Block - ManagementServices
# Create Alarms
############################

module "alarms" {
  source                = "./modules/managementservices/alarm"
  for_each              = var.alarms != null ? var.alarms : {}

  alarm_name           = each.value.alarm_name
  compartment_name = each.value.compartment_name != null ? (length(regexall("ocid1.compartment.oc1*", each.value.compartment_name)) > 0 ? each.value.compartment_name : var.compartment_ocids[0][each.value.compartment_name]) : var.tenancy_ocid
  destinations = [for tn in each.value.destinations : ( length(regexall("ocid1.onstopic.oc1*",tn)) > 0 ? tn : merge(module.notifications_topics.*...)[tn]["topic_id"][tn])]
  is_enabled  = each.value.is_enabled
  metric_compartment_name = each.value.metric_compartment_name != null ? (length(regexall("ocid1.compartment.oc1*", each.value.metric_compartment_name)) > 0 ? each.value.metric_compartment_name : var.compartment_ocids[0][each.value.metric_compartment_name]) : var.tenancy_ocid
  namespace      = each.value.namespace
  query          = each.value.query
  severity       = each.value.severity
  body           = each.value.body
  message_format = each.value.message_format
  trigger_delay_minutes = each.value.trigger_delay_minutes == null ? "" : each.value.trigger_delay_minutes
  repeat_notification_duration = each.value.repeat_notification_duration == null ? "" : each.value.repeat_notification_duration
  

  #Optional
  defined_tags  = each.value.defined_tags
  freeform_tags = each.value.freeform_tags
}

/*
output "policies_id_map" {
  value = [ for k,v in merge(module.iam-policies.*...) : v.policies_id_map]
}
*/