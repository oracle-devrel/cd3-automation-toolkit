// Copyright (c) 2021, 2022, Oracle and/or its affiliates.

############################
# Module Block - Identity
# Create Policies
############################

module "iam-policies" {
  source                = "./modules/identity/iam-policy"
  for_each              = var.policies != null ? var.policies : {}

  depends_on            = [module.iam-groups]
  tenancy_ocid          = var.tenancy_ocid
  policy_name           = each.value.name
  policy_compartment_id = each.value.compartment_name != null ? (length(regexall("ocid1.compartment.oc1*", each.value.compartment_name)) > 0 ? each.value.compartment_name : var.compartment_ocids[0][each.value.compartment_name]) : var.tenancy_ocid
  policy_description = each.value.policy_description
  policy_statements  = each.value.policy_statements

  #Optional
  defined_tags  = each.value.defined_tags
  freeform_tags = each.value.freeform_tags
}

/*
output "policies_id_map" {
  value = [ for k,v in merge(module.iam-policies.*...) : v.policies_id_map]
}
*/